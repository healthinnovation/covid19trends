---
title: "COVID-19 trends"
author: "Diego Villa"
format: html
editor: source
---

```{r}
library(dplyr)
library(ggplot2)
```

## Figure 1A 

```{r}
cases <- readr::read_csv("data/processed/cases.csv", col_types = "cDi")
deaths <- readr::read_csv("data/processed/deaths.csv", col_types = "cDi")
```

```{r}
cases_weekly  <- cases |> 
  group_by(week_start) |> 
  summarise(cases = sum(cases), .groups = "drop")

deaths_weekly <- deaths |> 
  group_by(week_start) |> 
  summarise(deaths = sum(deaths), .groups = "drop")
```

```{r}
weekly_list <- list(cases_weekly, deaths_weekly)
```

```{r}
weekly <- purrr::reduce(weekly_list, \(x, y) inner_join(x, y, by = "week_start"))
```

```{r}
weekly_long <- weekly |> 
  tidyr::pivot_longer(-week_start) |> 
  mutate(year_week = tsibble::yearweek(x = week_start, week_start = 7))
```

```{r}
facet_names = c("cases" = "Positive cases", "deaths" = "Deaths")
```

```{r}
weekly_plot_base <- ggplot(weekly_long, aes(week_start, value)) +
  facet_wrap(
    ~name, ncol = 1, scales = "free", labeller = labeller(name = facet_names),
    strip.position = "right"
  ) +
  geom_area(fill = "#00A087FF")
```

```{r}
weekly_plot <- weekly_plot_base +
  scale_x_date(date_breaks = "5 months", date_labels = "%b, %Y") +
  scale_y_continuous(labels = scales::label_comma(), expand = c(0, 0)) +
  theme_minimal() +
  theme(
    axis.line.x = element_line(color = "lightgray"),
    axis.ticks.x = element_line(color = "lightgray"),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.minor.y = element_blank()
  ) +
  labs(
    y = NULL, x = NULL,
    title = "Weekly COVID-19 positive cases and deaths",
    subtitle = "EW 10, 2020 to EW 03, 2024"
  )
```

```{r}
#| fig-width: 10
#| fig-height: 9
weekly_plot
```

```{r}
#| eval: false 
ggsave("figures/weekly-plot.png", weekly_plot, width = 10, height = 7)
```

## Figure 1B 

```{r}
library(sf)
```

```{r}
data("Peru", package = "innovar")
districts <- Peru |> 
  st_drop_geometry() |> 
  select(ubigeo, department = dep, province = prov, district = distr)
```

```{r}
districts_counts <- cases |> 
  inner_join(deaths, by = c("ubigeo", "week_start")) |> 
  left_join(districts, by = "ubigeo")
```

```{r}
population_raw <- readr::read_csv("data/raw/population.csv", col_types = "cii")
population = population_raw |> 
  filter(year == 2020) |> 
  select(-year)
```

```{r}
provinces_counts <- districts_counts |> 
  group_by(department, province) |> 
  summarise(cases = sum(cases), deaths = sum(deaths), .groups = "drop")
```

```{r}
provinces_population <- districts |> 
  inner_join(population, by = "ubigeo") |> 
  group_by(department, province) |> 
  summarise(population = sum(population), .groups = "drop")
```

```{r}
provinces_rates <- provinces_counts |> 
  left_join(provinces_population, by = c("department", "province")) |> 
  mutate(across(cases:deaths, \(x) 100000 * x / population), .keep = "unused")
```

```{r}
library(biscale)
```

```{r}
provinces_rates_bivariate <- bi_class(
  provinces_rates, x = cases, y = deaths, style = "jenks", dim = 3
)
```

```{r}
provinces_sf <- Peru |> 
  group_by(province = prov) |> 
  summarise() |> 
  ungroup() |> 
  st_as_sf()
```

```{r}
provinces_rates_bivariate_sf <- provinces_rates_bivariate |> 
  left_join(provinces_sf, by = "province") |> 
  st_as_sf()
```

```{r}
provinces_rates_bivariate_map <- provinces_rates_bivariate_sf |>
  ggplot() + 
  geom_sf(aes(fill = bi_class), show.legend = FALSE) +
  bi_scale_fill(pal = "GrPink", dim = 3) +
  theme_void() 
```

```{r}
legend_bivariate <- bi_legend(
    pal = "GrPink", dim = 3, xlab = "Higher incidence rate ", 
    ylab = "Higher death rate ", size = 8
  ) +
  theme(
    panel.background = element_rect(fill = "transparent"),
    plot.background = element_rect(fill = "transparent", color = NA)
  )
```

```{r}
library(cowplot)
```

```{r}
provinces_rates_bivariate_map_plot_raw <- ggdraw() +
  draw_plot(provinces_rates_bivariate_map, height = 1.15) +
  draw_plot(legend_bivariate, 0.12, 0.05, 0.28, 0.28) 

provinces_rates_bivariate_map_plot <- provinces_rates_bivariate_map_plot_raw |> 
  ggplotify::as.ggplot() +
  labs(
    fill = "Cases per 100,000 pop.",
    title = "Cumulative COVID-19 incidence and death rate\nby province",
    subtitle = "EW 10, 2020 to EW 03, 2024"
  )

provinces_rates_bivariate_map_plot
```

```{r}
ggsave(
  "figures/provinces_rates_bivariate_map_plot.png",
  provinces_rates_bivariate_map_plot, 
  width = 6, height = 7, bg = "transparent"
)
```

## Figure 1C

```{r}
departments <- districts |>
  inner_join(population, by = "ubigeo") |>
  group_by(department) |>
  summarise(population = sum(population))
```

```{r}
department_cases_weekly <- cases |>
  left_join(districts, by = "ubigeo") |>
  group_by(department, week_start) |>
  summarise(cases = sum(cases), .groups = "drop")
```

```{r}
department_deaths_weekly <- deaths |>
  left_join(districts, by = "ubigeo") |>
  group_by(department, week_start) |>
  summarise(deaths = sum(deaths), .groups = "drop")
```

```{r}
department_weekly_counts <- department_cases_weekly |>
  inner_join(department_deaths_weekly, by = c("department", "week_start"))
```

```{r}
department_rates_weekly <- department_weekly_counts |> 
  inner_join(departments, by = "department") |> 
  mutate(across(cases:deaths, \(x) 100000 * x / population), .keep = "unused")
```

```{r}
dep_rates_weekly_class <- department_rates_weekly |> 
  mutate(
    across(
      cases:deaths, 
      \(x) cut(
        x, breaks = cartography::getBreaks(x, nclass = 4, method = "quantile"), 
        include.lowest = TRUE, dig.lab = 5
      ),
      .names = "{.col}_quantile"
    ),
    across(
      cases:deaths, 
      \(x) cut(
        x, breaks = cartography::getBreaks(x, nclass = 4, method = "kmeans"), 
        include.lowest = TRUE, dig.lab = 5
      ),
      .names = "{.col}_kmeans"
    ),
    across(
      cases:deaths, 
      \(x) cut(
        x, breaks = cartography::getBreaks(x, nclass = 4, method = "bclust"), 
        include.lowest = TRUE, dig.lab = 5
      ),
      .names = "{.col}_bclust"
    ),
    across(
      cases:deaths, 
      \(x) cut(
        x, breaks = cartography::getBreaks(x, nclass = 4, method = "fisher"), 
        include.lowest = TRUE, dig.lab = 5
      ),
      .names = "{.col}_fisher"
    ),
    across(
      cases:deaths, 
      \(x) cut(
        x, breaks = cartography::getBreaks(x, nclass = 4, method = "geom"), 
        include.lowest = TRUE, dig.lab = 5
      ),
      .names = "{.col}_geom"
    ),
    across(
      cases:deaths, 
      \(x) cut(
        x, breaks = cartography::getBreaks(x, nclass = 4, method = "arith"), 
        include.lowest = TRUE, dig.lab = 5
      ),
      .names = "{.col}_arith"
    ),
    across(
      cases:deaths, 
      \(x) cut(
        x, breaks = cartography::getBreaks(x, nclass = 4, method = "em"), 
        include.lowest = TRUE, dig.lab = 5
      ),
      .names = "{.col}_em"
    ),
    .keep = "unused"
  )
```

```{r}
heatmap_dep_week_classes <- dep_rates_weekly_class |> 
  ggplot(aes(department, week_start, fill = cases_em)) +
  geom_tile() +
  coord_flip() +
  scale_y_date(
    date_breaks = "5 months", date_labels = "%b, %Y", expand = c(0, 0)
  ) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_fill_brewer(palette = "OrRd") +
  labs(
    y = "Epidemiological Week", x = "Departments", 
    fill = "Positive cases\nper 100,000 pop.",
    title = "Weekly COVID-19 incidence by department",
    subtitle = "EW 10, 2020 to EW 03, 2024"
  ) +
  theme(
    legend.position = "top",
    panel.background = element_rect(fill = "transparent"),
    plot.background = element_rect(fill = "transparent", color = NA),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.background = element_rect(fill = "transparent")
  )

heatmap_dep_week_classes
```

```{r}
ggsave(
  "figures/heatmap_dep_week_classes.png", heatmap_dep_week_classes, 
  height = 6, width = 9, bg = "transparent"
)
```

## Figure 1

```{r}
library(patchwork)
```

```{r fig.height=11, fig.width=15}
weekly_plot / (provinces_rates_bivariate_map_plot + heatmap_dep_week_classes)
```

```{r}
ggsave("figures/panel.png", height = 14, width = 16, bg = "transparent")
```




